---

name: AWS CDK Python app testing


defaults:
  run:
    # The shell steps in this workflow don't need Bash,
    # which is the default on Linux runners;
    # POSIX shell functionality suffices.
    shell: sh


env:
  # Without quotes, this key could be parsed as the boolean false value instead of the string "false"
  npm_config_fund: 'false'
  npm_config_loglevel: verbose


# Without quotes, this key could be parsed as the boolean true value instead of the string "on"
'on':
  workflow_call:


jobs:

  doctor:
    name: Check CDK app for potential problems
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      -
        name: Check out corresponding git branch
        uses: actions/checkout@v3
        with:
          # This job does not require git history
          fetch-depth: 1
      -
        name: Set up npm
        uses: evoila/GitHub-Actions/.github/actions/setup-npm@stage
      -
        name: Set up Poetry
        uses: evoila/GitHub-Actions/.github/actions/setup-Poetry@stage
      -
        name: Check CDK app for potential problems
        # The `cdk` command must run under both `poetry run` and `npx` because:
        #  - the dependencies of the CDK code are installed in a virtualenv managed by Poetry; and
        #  - the command `cdk` itself is installed locally by npm.
        run: >-
          poetry
          --verbose
          run
          --
          npx
          --
          cdk
          --ci
          --lookups=false
          --notices
          --output=cdk.out
          --strict
          --verbose
          doctor

  # What gets deployed are the CloudFormation templates generated by the CDK.
  # Being able to look into what the CDK generated can be useful when debugging issues.
  synthesize:
    name: Synthesize CloudFormation templates from CDK app
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      -
        name: Check out corresponding git branch
        uses: actions/checkout@v3
        with:
          # This job does not require git history
          fetch-depth: 1
      -
        name: Set up npm
        uses: evoila/GitHub-Actions/.github/actions/setup-npm@stage
      -
        name: Set up Poetry
        uses: evoila/GitHub-Actions/.github/actions/setup-Poetry@stage
      -
        name: Synthesize CloudFormation templates from CDK app
        # The `cdk` command must run under both `poetry run` and `npx` because:
        #  - the dependencies of the CDK code are installed in a virtualenv managed by Poetry; and
        #  - the command `cdk` itself is installed locally by npm.
        run: >-
          poetry
          --verbose
          run
          --
          npx
          --
          cdk
          --ci
          --lookups=false
          --notices
          --output=cdk.out
          --strict
          --verbose
          synthesize
